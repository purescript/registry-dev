module Test.Integration where

import Registry.Prelude

import Control.Monad.Except as Except
import Data.Map as Map
import Effect.Exception as Exception
import Foreign.Git as Git
import Foreign.Tmp as Tmp
import Node.Path as Path
import Registry.Index as Index
import Registry.PackageName (PackageName)
import Registry.PackageName as PackageName
import Registry.Schema (Manifest(..))
import Registry.Solver as Solver
import Registry.Version (Version)
import Registry.Version as Version
import Test.Spec as Spec
import Test.Spec.Assertions as Assert

solverSpec :: Spec.SpecT Aff Unit Aff Unit
solverSpec = Spec.beforeAll setup do
  Spec.describe "Solves packages in 1.0.0 package set" do
    for_ packages \(Tuple name version) ->
      Spec.it (PackageName.print name <> "@" <> Version.printVersion version) \index -> do
        case Map.lookup version =<< Map.lookup name index of
          Nothing -> Assert.fail "Does not exist in registry index."
          Just deps -> do
            case Solver.solve index deps of
              Left err -> Assert.fail $ show err
              Right _ -> pure unit
  where
  setup = do
    tmp <- liftEffect Tmp.mkTmpDir
    Except.runExceptT (Git.runGit_ [ "clone", "https://github.com/purescript/registry-index" ] (Just tmp)) >>= case _ of
      Left err -> throwError (Exception.error err)
      Right _ -> pure unit
    indexFull <- Index.readRegistryIndex (Path.concat [ tmp, "registry-index" ])
    pure $ map (map (\(Manifest m) -> m.dependencies)) indexFull

packages :: Array (Tuple PackageName Version)
packages = map (bimap (unsafeFromRight <<< PackageName.parse) (unsafeFromRight <<< Version.parseVersion Version.Strict))
  [ "ace" /\ "9.0.0"
  , "aff" /\ "7.0.0"
  , "aff-bus" /\ "6.0.0"
  , "aff-coroutines" /\ "9.0.0"
  , "aff-promise" /\ "4.0.0"
  , "aff-retry" /\ "2.0.0"
  , "affjax" /\ "13.0.0"
  , "affjax-node" /\ "1.0.0"
  , "affjax-web" /\ "1.0.0"
  , "ansi" /\ "7.0.0"
  , "argonaut" /\ "9.0.0"
  , "argonaut-codecs" /\ "9.0.0"
  , "argonaut-core" /\ "7.0.0"
  , "argonaut-generic" /\ "8.0.0"
  , "argonaut-traversals" /\ "10.0.0"
  , "argparse-basic" /\ "2.0.0"
  , "array-builder" /\ "0.1.2"
  , "arraybuffer" /\ "13.0.0"
  , "arraybuffer-builder" /\ "3.0.1"
  , "arraybuffer-types" /\ "3.0.2"
  , "arrays" /\ "7.0.0"
  , "arrays-zipper" /\ "2.0.1"
  , "ask" /\ "1.0.0"
  , "assert" /\ "6.0.0"
  , "avar" /\ "5.0.0"
  , "b64" /\ "0.0.8"
  , "barlow-lens" /\ "0.9.0"
  , "bifunctors" /\ "6.0.0"
  , "bigints" /\ "7.0.1"
  , "bolson" /\ "0.0.6"
  , "bower-json" /\ "3.0.0"
  , "call-by-name" /\ "4.0.1"
  , "canvas" /\ "6.0.0"
  , "canvas-action" /\ "9.0.0"
  , "cartesian" /\ "1.0.6"
  , "catenable-lists" /\ "7.0.0"
  , "channel" /\ "1.0.0"
  , "checked-exceptions" /\ "3.1.1"
  , "codec" /\ "5.0.0"
  , "codec-argonaut" /\ "9.0.0"
  , "colors" /\ "7.0.1"
  , "concurrent-queues" /\ "3.0.0"
  , "console" /\ "6.0.0"
  , "const" /\ "6.0.0"
  , "contravariant" /\ "6.0.0"
  , "control" /\ "6.0.0"
  , "convertable-options" /\ "1.0.0"
  , "coroutines" /\ "7.0.0"
  , "css" /\ "6.0.0"
  , "datetime" /\ "6.0.0"
  , "datetime-parsing" /\ "0.2.0"
  , "debug" /\ "6.0.0"
  , "decimals" /\ "7.0.0"
  , "deku" /\ "0.4.13"
  , "deno" /\ "0.0.5"
  , "dissect" /\ "1.0.0"
  , "distributive" /\ "6.0.0"
  , "dodo-printer" /\ "2.2.0"
  , "dom-indexed" /\ "11.0.0"
  , "droplet" /\ "0.4.0"
  , "dynamic-buffer" /\ "3.0.1"
  , "effect" /\ "4.0.0"
  , "either" /\ "6.1.0"
  , "elmish" /\ "0.8.2"
  , "elmish-enzyme" /\ "0.1.1"
  , "elmish-hooks" /\ "0.8.2"
  , "elmish-html" /\ "0.7.1"
  , "email-validate" /\ "7.0.0"
  , "encoding" /\ "0.0.8"
  , "enums" /\ "6.0.0"
  , "exceptions" /\ "6.0.0"
  , "exists" /\ "6.0.0"
  , "exitcodes" /\ "4.0.0"
  , "expect-inferred" /\ "3.0.0"
  , "fast-vect" /\ "0.7.0"
  , "filterable" /\ "5.0.0"
  , "fixed-points" /\ "7.0.0"
  , "fixed-precision" /\ "5.0.0"
  , "flame" /\ "1.2.0"
  , "float32" /\ "2.0.0"
  , "foldable-traversable" /\ "6.0.0"
  , "foreign" /\ "7.0.0"
  , "foreign-object" /\ "4.0.0"
  , "foreign-readwrite" /\ "3.0.0"
  , "fork" /\ "6.0.0"
  , "form-urlencoded" /\ "7.0.0"
  , "formatters" /\ "7.0.0"
  , "free" /\ "7.0.0"
  , "freeap" /\ "7.0.0"
  , "freer-free" /\ "0.0.1"
  , "freet" /\ "7.0.0"
  , "functions" /\ "6.0.0"
  , "functors" /\ "5.0.0"
  , "fuzzy" /\ "0.4.0"
  , "gen" /\ "4.0.0"
  , "generate-values" /\ "1.0.1"
  , "generic-router" /\ "0.0.1"
  , "geometry-plane" /\ "1.0.3"
  , "github-actions-toolkit" /\ "0.5.0"
  , "graphs" /\ "8.0.0"
  , "group" /\ "4.1.1"
  , "halogen" /\ "7.0.0"
  , "halogen-css" /\ "10.0.0"
  , "halogen-formless" /\ "4.0.0"
  , "halogen-hooks" /\ "0.6.0"
  , "halogen-hooks-extra" /\ "0.9.0"
  , "halogen-store" /\ "0.5.0"
  , "halogen-storybook" /\ "2.0.0"
  , "halogen-subscriptions" /\ "2.0.0"
  , "halogen-svg-elems" /\ "6.0.0"
  , "halogen-vdom" /\ "8.0.0"
  , "halogen-vdom-string-renderer" /\ "0.5.0"
  , "heckin" /\ "2.0.1"
  , "heterogeneous" /\ "0.6.0"
  , "heterogeneous-extrablatt" /\ "0.2.1"
  , "homogeneous" /\ "0.4.0"
  , "http-methods" /\ "6.0.0"
  , "httpure" /\ "0.15.0"
  , "httpurple" /\ "2.0.0"
  , "httpurple-argonaut" /\ "1.0.1"
  , "httpurple-yoga-json" /\ "1.0.0"
  , "hyrule" /\ "2.0.0"
  , "identity" /\ "6.0.0"
  , "indexed-monad" /\ "2.1.0"
  , "int64" /\ "2.0.0"
  , "integers" /\ "6.0.0"
  , "interpolate" /\ "5.0.0"
  , "invariant" /\ "6.0.0"
  , "js-date" /\ "8.0.0"
  , "js-fileio" /\ "3.0.0"
  , "js-timers" /\ "6.1.0"
  , "js-uri" /\ "3.0.0"
  , "justifill" /\ "0.5.0"
  , "jwt" /\ "0.0.9"
  , "language-cst-parser" /\ "0.12.0"
  , "lazy" /\ "6.0.0"
  , "lazy-joe" /\ "1.0.0"
  , "lcg" /\ "4.0.0"
  , "leibniz" /\ "5.0.0"
  , "linalg" /\ "5.1.0"
  , "lists" /\ "7.0.0"
  , "literals" /\ "1.0.2"
  , "logging" /\ "3.0.0"
  , "logging-journald" /\ "0.4.0"
  , "machines" /\ "7.0.0"
  , "matrices" /\ "5.0.1"
  , "matryoshka" /\ "1.0.0"
  , "maybe" /\ "6.0.0"
  , "media-types" /\ "6.0.0"
  , "midi" /\ "4.0.0"
  , "milkis" /\ "9.0.0"
  , "minibench" /\ "4.0.0"
  , "mmorph" /\ "7.0.0"
  , "monad-control" /\ "5.0.0"
  , "monad-logger" /\ "1.3.1"
  , "monad-loops" /\ "0.5.0"
  , "monad-unlift" /\ "1.0.1"
  , "monoid-extras" /\ "0.0.1"
  , "monoidal" /\ "0.16.0"
  , "morello" /\ "0.3.2"
  , "motsunabe" /\ "2.0.0"
  , "nano-id" /\ "1.1.0"
  , "naturals" /\ "3.0.0"
  , "nested-functor" /\ "0.2.1"
  , "newtype" /\ "5.0.0"
  , "node-buffer" /\ "8.0.0"
  , "node-buffer-blob" /\ "1.0.0"
  , "node-child-process" /\ "9.0.0"
  , "node-fs" /\ "8.0.0"
  , "node-fs-aff" /\ "9.0.0"
  , "node-http" /\ "8.0.0"
  , "node-net" /\ "4.0.0"
  , "node-path" /\ "5.0.0"
  , "node-process" /\ "10.0.0"
  , "node-readline" /\ "7.0.0"
  , "node-streams" /\ "7.0.0"
  , "node-streams-aff" /\ "4.0.0"
  , "node-url" /\ "6.0.0"
  , "nonempty" /\ "7.0.0"
  , "now" /\ "6.0.0"
  , "npm-package-json" /\ "2.0.0"
  , "nullable" /\ "6.0.0"
  , "numbers" /\ "9.0.0"
  , "open-folds" /\ "6.3.0"
  , "open-memoize" /\ "6.1.0"
  , "open-pairing" /\ "6.1.0"
  , "options" /\ "7.0.0"
  , "optparse" /\ "5.0.0"
  , "ordered-collections" /\ "3.0.0"
  , "ordered-set" /\ "0.4.0"
  , "orders" /\ "6.0.0"
  , "pairs" /\ "9.0.0"
  , "parallel" /\ "6.0.0"
  , "parsing" /\ "9.1.0"
  , "parsing-dataview" /\ "3.1.0"
  , "partial" /\ "4.0.0"
  , "pathy" /\ "9.0.0"
  , "pha" /\ "0.9.0"
  , "phaser" /\ "0.6.0"
  , "pipes" /\ "8.0.0"
  , "point-free" /\ "1.0.0"
  , "pointed-list" /\ "0.5.1"
  , "polymorphic-vectors" /\ "4.0.0"
  , "posix-types" /\ "6.0.0"
  , "precise" /\ "6.0.0"
  , "precise-datetime" /\ "7.0.0"
  , "prelude" /\ "6.0.0"
  , "prettier-printer" /\ "3.0.0"
  , "profunctor" /\ "6.0.0"
  , "profunctor-lenses" /\ "8.0.0"
  , "protobuf" /\ "4.0.0"
  , "ps-cst" /\ "1.2.0"
  , "psa-utils" /\ "8.0.0"
  , "psc-ide" /\ "19.0.0"
  , "psci-support" /\ "6.0.0"
  , "qualified-do" /\ "2.2.0"
  , "quantities" /\ "12.0.1"
  , "quickcheck" /\ "8.0.1"
  , "quickcheck-combinators" /\ "0.1.3"
  , "quickcheck-laws" /\ "7.0.0"
  , "quickcheck-utf8" /\ "0.0.0"
  , "quotient" /\ "3.0.0"
  , "random" /\ "6.0.0"
  , "rationals" /\ "5.0.0"
  , "react" /\ "10.0.1"
  , "react-basic" /\ "17.0.0"
  , "react-basic-dom" /\ "5.0.0"
  , "react-basic-hooks" /\ "8.0.0"
  , "react-dom" /\ "8.0.0"
  , "read" /\ "1.0.1"
  , "record" /\ "4.0.0"
  , "refined" /\ "1.0.0"
  , "refs" /\ "6.0.0"
  , "remotedata" /\ "5.0.0"
  , "resource" /\ "2.0.1"
  , "resourcet" /\ "1.0.0"
  , "result" /\ "1.0.3"
  , "return" /\ "0.2.0"
  , "ring-modules" /\ "5.0.1"
  , "routing" /\ "11.0.0"
  , "routing-duplex" /\ "0.6.0"
  , "run" /\ "5.0.0"
  , "safe-coerce" /\ "2.0.0"
  , "safely" /\ "4.0.1"
  , "selection-foldable" /\ "0.2.0"
  , "semirings" /\ "7.0.0"
  , "signal" /\ "13.0.0"
  , "simple-emitter" /\ "2.0.0"
  , "simple-json" /\ "9.0.0"
  , "sized-matrices" /\ "1.0.0"
  , "sized-vectors" /\ "5.0.2"
  , "slug" /\ "3.0.1"
  , "soundfonts" /\ "4.1.0"
  , "sparse-matrices" /\ "1.2.1"
  , "sparse-polynomials" /\ "1.0.5"
  , "spec" /\ "7.0.0"
  , "spec-discovery" /\ "8.0.0"
  , "spec-quickcheck" /\ "5.0.0"
  , "ssrs" /\ "1.0.0"
  , "st" /\ "6.0.0"
  , "strictlypositiveint" /\ "1.0.1"
  , "string-parsers" /\ "8.0.0"
  , "strings" /\ "6.0.0"
  , "strings-extra" /\ "4.0.0"
  , "stringutils" /\ "0.0.12"
  , "substitute" /\ "0.2.3"
  , "supply" /\ "0.2.0"
  , "systemd-journald" /\ "0.3.0"
  , "tailrec" /\ "6.0.0"
  , "test-unit" /\ "17.0.0"
  , "thermite" /\ "6.3.1"
  , "thermite-dom" /\ "0.3.1"
  , "these" /\ "6.0.0"
  , "transformers" /\ "6.0.0"
  , "tree-rose" /\ "4.0.2"
  , "tuples" /\ "7.0.0"
  , "two-or-more" /\ "1.0.0"
  , "type-equality" /\ "4.0.1"
  , "typelevel" /\ "6.0.0"
  , "typelevel-lists" /\ "2.1.0"
  , "typelevel-peano" /\ "1.0.1"
  , "typelevel-prelude" /\ "7.0.0"
  , "typelevel-rows" /\ "0.1.0"
  , "uint" /\ "7.0.0"
  , "uncurried-transformers" /\ "1.1.0"
  , "undefined-is-not-a-problem" /\ "1.1.0"
  , "unfoldable" /\ "6.0.0"
  , "unicode" /\ "6.0.0"
  , "unlift" /\ "1.0.1"
  , "unordered-collections" /\ "3.0.0"
  , "unsafe-coerce" /\ "6.0.0"
  , "unsafe-reference" /\ "5.0.0"
  , "uri" /\ "9.0.0"
  , "validation" /\ "6.0.0"
  , "variant" /\ "8.0.0"
  , "vectorfield" /\ "1.0.1"
  , "versions" /\ "7.0.0"
  , "web-clipboard" /\ "4.0.0"
  , "web-cssom" /\ "2.0.0"
  , "web-dom" /\ "6.0.0"
  , "web-dom-parser" /\ "8.0.0"
  , "web-dom-xpath" /\ "3.0.0"
  , "web-encoding" /\ "3.0.0"
  , "web-events" /\ "4.0.0"
  , "web-fetch" /\ "3.0.0"
  , "web-file" /\ "4.0.0"
  , "web-html" /\ "4.0.0"
  , "web-pointerevents" /\ "1.0.0"
  , "web-promise" /\ "3.0.0"
  , "web-socket" /\ "4.0.0"
  , "web-storage" /\ "5.0.0"
  , "web-streams" /\ "3.0.0"
  , "web-touchevents" /\ "4.0.0"
  , "web-uievents" /\ "4.0.0"
  , "web-workers" /\ "1.1.0"
  , "web-xhr" /\ "5.0.0"
  , "yoga-fetch" /\ "1.0.1"
  , "yoga-json" /\ "2.0.0"
  , "yoga-postgres" /\ "6.0.0"
  ]
